---
description: 
globs: apps/backend/**/*
alwaysApply: false
---
The following rules should always be followed when working within the `apps/backend` directory.

# Backend (`apps/backend`)

## Core Technologies

- **Framework:** HonoJS
- **Database ORM:** Drizzle ORM with PostgreSQL
- **Environment Variables:** Managed via `src/appEnv.ts`

## Directory Structure & Conventions

- **Validation:**
  - For any route that requires input validation (except for "get all" routes), define the Zod schema in `packages/validation/src/schemas`.
  - Re-export all schemas via `packages/validation/src/index.ts`.
  - Import validation schemas in backend code using `@repo/validation`.


- **Main Entry Point:** `src/index.ts` is the primary application entry point.
- **Database:**
  - Schema definitions reside in `src/drizzle/schema/[modelName]Schema.ts`.
  - All schemas must be imported and included in the Drizzle instance in `src/drizzle/index.ts`.
  - Use imports from `drizzle-orm/pg-core`.
  - Prefer `db.query...` for data fetching over `db.select()`.
- **Routing:**
  - Define API routes within `src/routes/`.
  - Colocate related endpoints in a single file (e.g., `src/routes/usersRoute.ts`). Split into multiple files if a resource has many endpoints.
  - Each route endpoint should be defined in its own file (e.g., `create-user.ts`, `delete-user.ts`, `get-all-users.ts`).
  - Group and import them in the corresponding route file (e.g., `src/routes/users/route.ts`).
  - Add comments indicating the HTTP method and subpath for each route:
    ```ts
    export const brandRoutes = createHonoRoute()
      .use(authInfo)
      .route("/", getAllBrandsRoute) //GET /
      .route(":id", getBrandByIdRoute) //GET /:id
      .route("/", createBrandRoute) //POST /
      .route(":id", updateBrandRoute) //PUT /:id
      .route(":id", deleteBrandRoute); //DELETE /:id
    ```
  - Each route must be protected using the `checkPermission` middleware (e.g., `checkPermission("users.read")`).
  - The list of available permissions resides in `@repo/data` under `packages/data/src/permissions.ts`. If a permission does not exist, you must create it.
  - For "get all" routes only:
    - Must use `requestValidator("query", paginationRequestSchema)` from `@repo/validation`.
    - The business logic should support filtering, sorting, and searching via the `q` query parameter.
    - The response format must follow this shape:
      ```ts
      {
        data,
        _metadata: {
          currentPage: page,
          totalPages,
          totalItems,
          perPage: limit,
        }
      }
      ```
    - Apply permission checks using middleware where necessary.
- **Middleware:**
  - Place custom Hono middleware functions in `src/middlewares/`.
- **Services:**
  - Encapsulate business logic within `src/services/` to keep routes clean.
- **Utilities:**
  - General utility functions should be placed in `src/utils/`.
- **Types:**
  - Define custom TypeScript types and interfaces in `src/types/`.
- **Error Handling:**
  - Implement custom error classes or handling logic within `src/errors/`.
- **Static Data:**
  - Place backend-specific static data (if any, different from `packages/data`) in `src/data/`.
- **Testing:**
  - Test files should be co-located with the code they test or follow standard naming conventions (e.g., `*.test.ts`).

## Code Style & Best Practices

- **Imports:** Use relative paths for imports within the `apps/backend` module.
- **Asynchronous Operations:** Use `async/await` for all asynchronous operations, especially database queries and external API calls.
- **Error Handling:** Implement robust error handling, potentially using the custom errors defined in `src/errors/`.
- **Security:** Be mindful of potential security vulnerabilities, especially SQL injection (Drizzle helps, but be cautious with raw queries if used) and input validation (potentially using Zod schemas from `packages/validation`).
- **Dependencies:** Manage dependencies using Bun via the `package.json` file.

## Operations

- **Migrations:** Do not run database migrations automatically. Follow the project's defined migration process.
- **Development Server:** Do not run commands to start the development server automatically.

