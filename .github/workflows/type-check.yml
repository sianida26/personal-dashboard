name: TypeScript Type Check

on:
  pull_request:
    paths:
      - "apps/backend/**"
      - "apps/frontend/**"
      - "packages/**"
      - "tsconfig.json"
      - ".github/workflows/type-check.yml"

env:
  WAHA_API_URL: "https://your-waha-instance.com"
  WAHA_SESSION: "default"
  WAHA_CHAT_ID: "your-chat-id@c.us"

jobs:
  type-check:
    runs-on: dsg-owned
    strategy:
      matrix:
        include:
          - name: Backend
            working-directory: apps/backend
          - name: Frontend
            working-directory: apps/frontend

    name: Type Check - ${{ matrix.name }}
    steps:
      - name: Record start time
        id: start-time
        run: echo "timestamp=$(date +%s)" >> $GITHUB_OUTPUT

      - name: Send start notification
        continue-on-error: true
        run: |
          curl -X POST "${{ env.WAHA_API_URL }}/api/sendText" \
            -H "Content-Type: application/json" \
            -H "X-Api-Key: ${{ secrets.WAHA_API_KEY }}" \
            -d '{
              "session": "${{ env.WAHA_SESSION }}",
              "chatId": "${{ env.WAHA_CHAT_ID }}",
              "text": "üîÑ *CI/CD Started*\n\n*Job:* Type Check - ${{ matrix.name }}\n*Status:* Running\n*Action:* ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}\n*Branch:* ${{ github.head_ref }}\n*Commit:* ${{ github.sha }}\n*Author:* ${{ github.actor }}"
            }'

      - uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Type check ${{ matrix.name }}
        run: bun run tsc --noEmit
        working-directory: ${{ matrix.working-directory }}

      - name: Calculate duration and send success notification
        if: success()
        continue-on-error: true
        run: |
          START_TIME=${{ steps.start-time.outputs.timestamp }}
          END_TIME=$(date +%s)
          DURATION=$((END_TIME - START_TIME))
          MINUTES=$((DURATION / 60))
          SECONDS=$((DURATION % 60))

          curl -X POST "${{ env.WAHA_API_URL }}/api/sendText" \
            -H "Content-Type: application/json" \
            -H "X-Api-Key: ${{ secrets.WAHA_API_KEY }}" \
            -d '{
              "session": "${{ env.WAHA_SESSION }}",
              "chatId": "${{ env.WAHA_CHAT_ID }}",
              "text": "‚úÖ *CI/CD Success*\n\n*Job:* Type Check - ${{ matrix.name }}\n*Status:* Success\n*Duration:* '"${MINUTES}m ${SECONDS}s"'\n*Action:* ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}\n*Branch:* ${{ github.head_ref }}\n*Commit:* ${{ github.sha }}\n*Author:* ${{ github.actor }}"
            }'

      - name: Calculate duration and send failure notification
        if: failure()
        continue-on-error: true
        run: |
          START_TIME=${{ steps.start-time.outputs.timestamp }}
          END_TIME=$(date +%s)
          DURATION=$((END_TIME - START_TIME))
          MINUTES=$((DURATION / 60))
          SECONDS=$((DURATION % 60))

          curl -X POST "${{ env.WAHA_API_URL }}/api/sendText" \
            -H "Content-Type: application/json" \
            -H "X-Api-Key: ${{ secrets.WAHA_API_KEY }}" \
            -d '{
              "session": "${{ env.WAHA_SESSION }}",
              "chatId": "${{ env.WAHA_CHAT_ID }}",
              "text": "‚ùå *CI/CD Failed*\n\n*Job:* Type Check - ${{ matrix.name }}\n*Status:* Failed\n*Duration:* '"${MINUTES}m ${SECONDS}s"'\n*Action:* ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}\n*Branch:* ${{ github.head_ref }}\n*Commit:* ${{ github.sha }}\n*Author:* ${{ github.actor }}"
            }'
