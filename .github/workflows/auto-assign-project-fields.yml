name: Auto-assign Project Fields

on:
    issues:
        types: [opened]
    project_card:
        types: [created]

jobs:
    assign-fields:
        runs-on: ubuntu-latest
        permissions:
            issues: write
            repository-projects: write
            contents: read

        steps:
            - name: Wait for project item creation
              run: sleep 5

            - name: Get Project Data
              id: get_project
              uses: actions/github-script@v7
              with:
                  github-token: ${{ secrets.GITHUB_TOKEN }}
                  script: |
                      const issue_number = context.payload.issue?.number;

                      if (!issue_number) {
                        console.log('No issue number found, skipping...');
                        return;
                      }

                      console.log(`Processing issue #${issue_number}`);

                      // Wait a bit more to ensure project item is created
                      await new Promise(resolve => setTimeout(resolve, 3000));

                      // Get organization or user projects
                      const owner = context.repo.owner;
                      const repo = context.repo.repo;

                      // GraphQL query to find the project item
                      const query = `
                        query($owner: String!, $repo: String!, $issue_number: Int!) {
                          repository(owner: $owner, name: $repo) {
                            issue(number: $issue_number) {
                              projectItems(first: 10) {
                                nodes {
                                  id
                                  project {
                                    id
                                    title
                                    number
                                    fields(first: 20) {
                                      nodes {
                                        ... on ProjectV2Field {
                                          id
                                          name
                                          dataType
                                        }
                                        ... on ProjectV2SingleSelectField {
                                          id
                                          name
                                          dataType
                                          options {
                                            id
                                            name
                                          }
                                        }
                                      }
                                    }
                                  }
                                }
                              }
                            }
                          }
                        }
                      `;

                      const result = await github.graphql(query, {
                        owner: owner,
                        repo: repo,
                        issue_number: issue_number
                      });

                      const projectItems = result.repository.issue.projectItems.nodes;

                      if (projectItems.length === 0) {
                        console.log('Issue not yet added to any project, skipping...');
                        return;
                      }

                      // Process each project the issue is added to
                      for (const item of projectItems) {
                        console.log(`Found project: ${item.project.title}`);
                        
                        const fields = item.project.fields.nodes;
                        const projectId = item.project.id;
                        const itemId = item.id;
                        
                        // Find the Estimate, Deadline, and Priority fields
                        const estimateField = fields.find(f => f.name === 'Estimate');
                        const deadlineField = fields.find(f => f.name === 'Deadline');
                        const priorityField = fields.find(f => f.name === 'Priority');
                        
                        // Set Estimate (if it's a number field, set to 0 or a default value)
                        if (estimateField && estimateField.dataType === 'NUMBER') {
                          console.log('Setting Estimate field...');
                          try {
                            await github.graphql(`
                              mutation($projectId: ID!, $itemId: ID!, $fieldId: ID!, $value: ProjectV2FieldValue!) {
                                updateProjectV2ItemFieldValue(input: {
                                  projectId: $projectId
                                  itemId: $itemId
                                  fieldId: $fieldId
                                  value: $value
                                }) {
                                  projectV2Item {
                                    id
                                  }
                                }
                              }
                            `, {
                              projectId: projectId,
                              itemId: itemId,
                              fieldId: estimateField.id,
                              value: { number: 0 }
                            });
                            console.log('Estimate field set successfully');
                          } catch (error) {
                            console.error('Error setting Estimate:', error.message);
                          }
                        }
                        
                        // Set Deadline (if it's a date field, set to 7 days from now)
                        if (deadlineField && deadlineField.dataType === 'DATE') {
                          console.log('Setting Deadline field...');
                          try {
                            const deadline = new Date();
                            deadline.setDate(deadline.getDate() + 7);
                            const deadlineStr = deadline.toISOString().split('T')[0];
                            
                            await github.graphql(`
                              mutation($projectId: ID!, $itemId: ID!, $fieldId: ID!, $value: ProjectV2FieldValue!) {
                                updateProjectV2ItemFieldValue(input: {
                                  projectId: $projectId
                                  itemId: $itemId
                                  fieldId: $fieldId
                                  value: $value
                                }) {
                                  projectV2Item {
                                    id
                                  }
                                }
                              }
                            `, {
                              projectId: projectId,
                              itemId: itemId,
                              fieldId: deadlineField.id,
                              value: { date: deadlineStr }
                            });
                            console.log('Deadline field set successfully');
                          } catch (error) {
                            console.error('Error setting Deadline:', error.message);
                          }
                        }
                        
                        // Set Priority (if it's a single select field, set to a default option)
                        if (priorityField && priorityField.dataType === 'SINGLE_SELECT') {
                          console.log('Setting Priority field...');
                          try {
                            // Find "Medium" option or use the first available option
                            const mediumOption = priorityField.options.find(opt => opt.name === 'Medium');
                            const defaultOption = mediumOption || priorityField.options[0];
                            
                            if (defaultOption) {
                              await github.graphql(`
                                mutation($projectId: ID!, $itemId: ID!, $fieldId: ID!, $value: ProjectV2FieldValue!) {
                                  updateProjectV2ItemFieldValue(input: {
                                    projectId: $projectId
                                    itemId: $itemId
                                    fieldId: $fieldId
                                    value: $value
                                  }) {
                                    projectV2Item {
                                      id
                                    }
                                  }
                                }
                              `, {
                                projectId: projectId,
                                itemId: itemId,
                                fieldId: priorityField.id,
                                value: { singleSelectOptionId: defaultOption.id }
                              });
                              console.log(`Priority field set to: ${defaultOption.name}`);
                            }
                          } catch (error) {
                            console.error('Error setting Priority:', error.message);
                          }
                        }
                      }

                      console.log('Project fields assignment completed');

            - name: Add comment
              if: success()
              uses: actions/github-script@v7
              with:
                  github-token: ${{ secrets.GITHUB_TOKEN }}
                  script: |
                      const issue_number = context.payload.issue?.number;
                      if (issue_number) {
                        await github.rest.issues.createComment({
                          owner: context.repo.owner,
                          repo: context.repo.repo,
                          issue_number: issue_number,
                          body: 'âœ… Project fields have been automatically assigned:\n- **Estimate**: 0\n- **Deadline**: 7 days from now\n- **Priority**: Medium\n\nYou can modify these values in the project board.'
                        });
                      }
