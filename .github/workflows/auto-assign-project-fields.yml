name: Auto-assign Project Fields

on:
  issues:
    types: [opened]

jobs:
  assign-fields:
    runs-on: ubuntu-latest
    permissions:
      issues: write
      repository-projects: write
      contents: read

    steps:
      - name: Wait for project item creation
        run: sleep 10

      - name: Get Project Data
        id: get_project
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const issue_number = context.payload.issue?.number;
            const issue_body = context.payload.issue?.body || '';

            if (!issue_number) {
              console.log('No issue number found, skipping...');
              return;
            }

            console.log(`Processing issue #${issue_number}`);

            // Parse footer values from issue body
            let estimate = 0;
            let daysUntilDeadline = 7;
            let priorityValue = 'Medium';

            // Extract Estimate (supports formats like "8 Points", "5", etc.)
            const estimateMatch = issue_body.match(/\*\*Estimate:\*\*\s*(\d+)(?:\s*Points?)?/i);
            if (estimateMatch) {
              estimate = parseInt(estimateMatch[1]);
              console.log(`Found Estimate: ${estimate}`);
            }

            // Extract Deadline (supports date format "20 Dec 2025" or relative like "7 days")
            const deadlineMatch = issue_body.match(/\*\*Deadline:\*\*\s*(.+?)(?:\n|$)/i);
            if (deadlineMatch) {
              const deadlineStr = deadlineMatch[1].trim();
              console.log(`Found Deadline string: ${deadlineStr}`);
              // Parse date if it's in format "DD MMM YYYY"
              const dateMatch = deadlineStr.match(/(\d{1,2})\s+(\w+)\s+(\d{4})/);
              if (dateMatch) {
                // Will be used as-is below
                console.log(`Parsed deadline date: ${deadlineStr}`);
              }
            }

            // Extract Priority (P0, P1, P2, P3)
            const priorityMatch = issue_body.match(/\*\*Priority:\*\*\s*(P[0-3])/i);
            if (priorityMatch) {
              const priority = priorityMatch[1].toUpperCase();
              console.log(`Found Priority: ${priority}`);
              
              // Map priority to deadline offset
              const priorityToDeadline = {
                'P0': 1,   // 1 day for critical
                'P1': 7,   // 1 week for high
                'P2': 14,  // 2 weeks for medium
                'P3': 30   // 1 month for low
              };
              
              daysUntilDeadline = priorityToDeadline[priority] || 7;
              priorityValue = priority;
            }

            // Get organization or user projects
            const owner = context.repo.owner;
            const repo = context.repo.repo;

            // GraphQL query to find the project item
            const query = `
              query($owner: String!, $repo: String!, $issue_number: Int!) {
                repository(owner: $owner, name: $repo) {
                  issue(number: $issue_number) {
                    projectItems(first: 10) {
                      nodes {
                        id
                        project {
                          id
                          title
                          number
                          fields(first: 20) {
                            nodes {
                              ... on ProjectV2Field {
                                id
                                name
                                dataType
                              }
                              ... on ProjectV2SingleSelectField {
                                id
                                name
                                dataType
                                options {
                                  id
                                  name
                                }
                              }
                            }
                          }
                        }
                      }
                    }
                  }
                }
              }
            `;

            // Retry logic to check for project items
            let projectItems = [];
            let maxRetries = 6; // Total wait time: 10s initial + (5s * 6) = 40s

            for (let attempt = 1; attempt <= maxRetries; attempt++) {
              console.log(`Checking for project items (attempt ${attempt}/${maxRetries})...`);
              
              const result = await github.graphql(query, {
                owner: owner,
                repo: repo,
                issue_number: issue_number
              });

              projectItems = result.repository.issue.projectItems.nodes;
              
              if (projectItems.length > 0) {
                console.log(`Found ${projectItems.length} project(s)`);
                break;
              }
              
              if (attempt < maxRetries) {
                console.log('No project items found yet, waiting 5 seconds...');
                await new Promise(resolve => setTimeout(resolve, 5000));
              }
            }

            if (projectItems.length === 0) {
              console.log('Issue not yet added to any project after multiple retries, skipping...');
              return;
            }

            // Process each project the issue is added to
            for (const item of projectItems) {
              console.log(`Found project: ${item.project.title}`);
              
              const fields = item.project.fields.nodes;
              const projectId = item.project.id;
              const itemId = item.id;
              
              // Find the Estimate, Deadline, and Priority fields
              const estimateField = fields.find(f => f.name === 'Estimate');
              const deadlineField = fields.find(f => f.name === 'Deadline');
              const priorityField = fields.find(f => f.name === 'Priority');
              
              // Set Estimate (if it's a number field, set to parsed value)
              if (estimateField && estimateField.dataType === 'NUMBER') {
                console.log(`Setting Estimate field to: ${estimate}`);
                try {
                  await github.graphql(`
                    mutation($projectId: ID!, $itemId: ID!, $fieldId: ID!, $value: ProjectV2FieldValue!) {
                      updateProjectV2ItemFieldValue(input: {
                        projectId: $projectId
                        itemId: $itemId
                        fieldId: $fieldId
                        value: $value
                      }) {
                        projectV2Item {
                          id
                        }
                      }
                    }
                  `, {
                    projectId: projectId,
                    itemId: itemId,
                    fieldId: estimateField.id,
                    value: { number: estimate }
                  });
                  console.log('Estimate field set successfully');
                } catch (error) {
                  console.error('Error setting Estimate:', error.message);
                }
              }
              
              // Set Deadline (if it's a date field, calculate from priority or use parsed date)
              if (deadlineField && deadlineField.dataType === 'DATE') {
                console.log('Setting Deadline field...');
                try {
                  // Check if there's a specific date in the footer
                  const deadlineMatch = issue_body.match(/\*\*Deadline:\*\*\s*(\d{1,2})\s+(\w+)\s+(\d{4})/i);
                  let deadlineStr;
                  
                  if (deadlineMatch) {
                    const day = deadlineMatch[1].padStart(2, '0');
                    const monthMap = {
                      'jan': '01', 'january': '01',
                      'feb': '02', 'february': '02',
                      'mar': '03', 'march': '03',
                      'apr': '04', 'april': '04',
                      'may': '05',
                      'jun': '06', 'june': '06',
                      'jul': '07', 'july': '07',
                      'aug': '08', 'august': '08',
                      'sep': '09', 'september': '09',
                      'oct': '10', 'october': '10',
                      'nov': '11', 'november': '11',
                      'dec': '12', 'december': '12'
                    };
                    const month = monthMap[deadlineMatch[2].toLowerCase()];
                    const year = deadlineMatch[3];
                    deadlineStr = `${year}-${month}-${day}`;
                    console.log(`Using parsed deadline: ${deadlineStr}`);
                  } else {
                    // Calculate based on priority
                    const deadline = new Date();
                    deadline.setDate(deadline.getDate() + daysUntilDeadline);
                    deadlineStr = deadline.toISOString().split('T')[0];
                    console.log(`Using calculated deadline (${daysUntilDeadline} days): ${deadlineStr}`);
                  }
                  
                  await github.graphql(`
                    mutation($projectId: ID!, $itemId: ID!, $fieldId: ID!, $value: ProjectV2FieldValue!) {
                      updateProjectV2ItemFieldValue(input: {
                        projectId: $projectId
                        itemId: $itemId
                        fieldId: $fieldId
                        value: $value
                      }) {
                        projectV2Item {
                          id
                        }
                      }
                    }
                  `, {
                    projectId: projectId,
                    itemId: itemId,
                    fieldId: deadlineField.id,
                    value: { date: deadlineStr }
                  });
                  console.log('Deadline field set successfully');
                } catch (error) {
                  console.error('Error setting Deadline:', error.message);
                }
              }
              
              // Set Priority (if it's a single select field, set to parsed priority)
              if (priorityField && priorityField.dataType === 'SINGLE_SELECT') {
                console.log(`Setting Priority field to: ${priorityValue}`);
                try {
                  // Find the matching priority option
                  const priorityOption = priorityField.options.find(opt => 
                    opt.name.toUpperCase() === priorityValue.toUpperCase() ||
                    opt.name === priorityValue
                  );
                  const defaultOption = priorityOption || priorityField.options[0];
                  
                  if (defaultOption) {
                    await github.graphql(`
                      mutation($projectId: ID!, $itemId: ID!, $fieldId: ID!, $value: ProjectV2FieldValue!) {
                        updateProjectV2ItemFieldValue(input: {
                          projectId: $projectId
                          itemId: $itemId
                          fieldId: $fieldId
                          value: $value
                        }) {
                          projectV2Item {
                            id
                          }
                        }
                      }
                    `, {
                      projectId: projectId,
                      itemId: itemId,
                      fieldId: priorityField.id,
                      value: { singleSelectOptionId: defaultOption.id }
                    });
                    console.log(`Priority field set to: ${defaultOption.name}`);
                  }
                } catch (error) {
                  console.error('Error setting Priority:', error.message);
                }
              }
            }

            console.log('Project fields assignment completed');

      - name: Add comment
        if: success()
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const issue_number = context.payload.issue?.number;
            if (issue_number) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue_number,
                body: 'âœ… Project fields have been automatically assigned based on the issue footer.\n\nYou can modify these values in the project board if needed.'
              });
            }
