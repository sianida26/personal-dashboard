FROM oven/bun:1-alpine AS base

ENV NODE_ENV=production
WORKDIR /node

FROM base AS pruner

COPY . .

RUN bunx turbo prune frontend --docker
RUN if [ -d patches ]; then mkdir -p out/json/patches && cp -R patches/. out/json/patches/; fi

FROM base AS installer

COPY --from=pruner /node/out/json/ ./
RUN bun install --frozen-lockfile --production

COPY --from=pruner /node/out/full/ ./

FROM base AS builder

COPY --from=installer /node/apps/frontend ./
COPY --from=installer /node/packages ./packages
COPY --from=installer /node/node_modules ./node_modules
COPY --from=installer /node/bun.lock ./bun.lock

ARG VITE_BACKEND_BASE_URL
RUN echo "VITE_BACKEND_BASE_URL=${VITE_BACKEND_BASE_URL}" > .env

RUN NODE_OPTIONS="--max-old-space-size=768" bun run build

FROM caddy:2-alpine AS production

COPY --from=builder /node/caddyfile /etc/caddy/caddyfile
COPY --from=builder /node/dist /srv

EXPOSE 80

CMD ["caddy", "run", "--config", "/etc/caddy/caddyfile"]
