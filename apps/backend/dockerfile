FROM oven/bun:1-alpine AS base

ENV NODE_ENV=production
ENV COREPACK_ENABLE_STRICT=0
ENV PNPM_HOME="/root/.local/share/pnpm"
ENV PATH="$PNPM_HOME:$PATH"
WORKDIR /node

RUN bun install -g pnpm@latest

FROM base AS builder

COPY . .

RUN printf 'packages:\n  - "packages/*"\n  - "apps/*"\n' > pnpm-workspace.yaml
RUN pnpm install
RUN pnpm exec turbo prune backend --docker

FROM base AS installer

COPY --from=builder /node/out/json/ ./
RUN pnpm install --frozen-lockfile --prod
COPY --from=builder /node/out/full/ .

FROM base AS production

COPY --from=installer /node/apps/backend/ ./
COPY --from=installer /node/node_modules ./node_modules
COPY --from=installer /node/package.json ./package.json
COPY --from=installer /node/bun.lock ./bun.lock

RUN mkdir -p /node/logs /node/keys /node/uploads \
  && chmod 777 /node/logs /node/keys /node/uploads

EXPOSE 81

CMD ["sh", "-c", "bun run db:migrate && bun run db:seed && bun run start"]
