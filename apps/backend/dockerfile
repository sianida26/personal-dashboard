FROM oven/bun:1-alpine AS base

ENV NODE_ENV=production
WORKDIR /node

FROM base AS pruner

COPY . .

RUN bunx turbo prune backend --docker
RUN if [ -d patches ]; then mkdir -p out/json/patches && cp -R patches/. out/json/patches/; fi

FROM base AS installer

COPY --from=pruner /node/out/json/ ./
RUN bun install --frozen-lockfile --production

COPY --from=pruner /node/out/full/ ./

FROM base AS production

COPY --from=installer /node/apps/backend ./
COPY --from=installer /node/packages ./packages
COPY --from=installer /node/node_modules ./node_modules
COPY --from=installer /node/bun.lock ./bun.lock

RUN mkdir -p /node/logs /node/keys /node/uploads \
  && chmod 777 /node/logs /node/keys /node/uploads

EXPOSE 81

CMD ["sh", "-c", "bun run db:prepare && bun run start || tail -f /dev/null"]
