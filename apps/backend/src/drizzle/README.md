# Drizzle ORM Layer (`apps/backend/src/drizzle`)

This directory contains the Drizzle ORM integration for the backend, including schema definitions, seeding, and utilities.  
**LLMs and contributors must strictly follow the conventions and rules below.**

---

## Structure

```
drizzle/
├── index.ts                # Drizzle ORM initialization and schema aggregation
├── migration.ts            # Migration runner (do not edit migrations folder)
├── seed.ts                 # Seeder runner
├── schema/                 # All table and relation definitions
│   └── [model]Schema.ts    # One file per model/table
├── seeds/                  # Seeder scripts for initial data
├── utils/                  # Drizzle-specific utilities (e.g., logging)
└── migrations/             # Auto-generated migration files (DO NOT TOUCH)
```

---

## General Rules

- **Migrations:**  
  - The `migrations/` folder is managed by Drizzle's migration tool.  
  - **LLMs and contributors must NOT edit, generate, or reference files in `migrations/` directly.**
- **Schema Definitions:**  
  - All table schemas must be defined in `schema/[modelName]Schema.ts`.
  - Each schema file should export both the table and its relations (see below).
  - All schemas must be imported and aggregated in `index.ts` for Drizzle initialization.
- **Relations:**  
  - **All relations must be strictly and explicitly defined** using Drizzle's `relations()` helper.
  - Use join tables (e.g., `rolesToUsers`, `permissionsToRoles`) for many-to-many relationships.
  - Always use the correct Drizzle import:  
    `import { pgTable, ... } from "drizzle-orm/pg-core";`
- **Naming:**  
  - Table names: snake_case, plural (e.g., `users`, `roles_to_users`).
  - Schema variable: `[modelName]Schema` (e.g., `rolesSchema`).
  - Relation variable: `[modelName]Relations` (e.g., `rolesRelations`).
- **TypeScript:**  
  - Avoid `any`. Use specific types or `unknown`.
  - Use null-coalescing (`??`) for defaults, not logical OR (`||`).
- **Documentation:**  
  - All functions, schemas, and ambiguous code must have JSDoc comments.

---

## File/Folder Purpose

- **index.ts**  
  - Loads environment, imports all schemas, and initializes Drizzle ORM.
  - Aggregates all schemas into the `schema` property for Drizzle.
  - Exports the configured `db` instance.

- **migration.ts**  
  - Runs Drizzle migrations using the `migrations/` folder.
  - **Do not edit or generate migration files manually.**

- **seed.ts**  
  - Runs all seeders in sequence for initial data population.

- **schema/**  
  - Contains all table and relation definitions.
  - Each file should define one table and its relations.
  - Example:  
    ```ts
    // roles.ts
    export const rolesSchema = pgTable(...);
    export const rolesRelations = relations(rolesSchema, ...);
    ```

- **seeds/**  
  - Contains seed scripts for each model/table.
  - Used by `seed.ts` for initial data.

- **utils/**  
  - Drizzle-specific utilities (e.g., `SqlLogger.ts` for query logging).

- **migrations/**  
  - Auto-generated by Drizzle.  
  - **Do not touch.**

---

## Example: Defining a Table and Relations

```ts
// schema/roles.ts
import { pgTable, text, ... } from "drizzle-orm/pg-core";
import { relations } from "drizzle-orm";
import { permissionsToRoles } from "./permissionsToRoles";

export const rolesSchema = pgTable("roles", { ... });

export const rolesRelations = relations(rolesSchema, ({ many }) => ({
  permissionsToRoles: many(permissionsToRoles),
}));
```

## ID Convention

- **All primary keys must use CUIDs generated by `@paralleldrive/cuid2`.**
- **Type:** Use `varchar` with a length of 25 for all `id` columns.
- **Default:** Use the `$defaultFn(() => createId())` to auto-generate IDs.
- **Example:**
  ```ts
  import { createId } from "@paralleldrive/cuid2";
  import { varchar } from "drizzle-orm/pg-core";

  // ...
  id: varchar("id", { length: 25 })
    .primaryKey()
    .$defaultFn(() => createId()),
  ```
- **Where:** This convention must be followed for all primary key columns in every schema file in `schema/`.

**Join Table Example:**

```ts
// schema/rolesToUsers.ts
import { pgTable, primaryKey, text } from "drizzle-orm/pg-core";
import { relations } from "drizzle-orm";
import { rolesSchema } from "./roles";
import { users } from "./users";

export const rolesToUsers = pgTable("roles_to_users", { ... });

export const rolesToUsersRelations = relations(rolesToUsers, ({ one }) => ({
  user: one(users, { fields: [rolesToUsers.userId], references: [users.id] }),
  role: one(rolesSchema, { fields: [rolesToUsers.roleId], references: [rolesSchema.id] }),
}));
```

---

## Adding a New Model

1. Create a new file in `schema/` (e.g., `products.ts`).
2. Define the table using `pgTable`.
3. Define all relations using `relations()`.
4. Import and spread the schema in `index.ts`'s `schema` property.
5. If needed, add a seeder in `seeds/` and update `seed.ts`.

---

## Utilities

- **SqlLogger:**  
  - Custom logger for Drizzle queries, using the app's logger.
  - Located in `utils/SqlLogger.ts`.

---

## Security & Best Practices

- Always use parameterized queries via Drizzle ORM.
- Never expose sensitive data in logs.
- Review all code for security vulnerabilities.
- Do not run migrations or seeders automatically in production.

---

## FAQ

- **Can I edit migration files?**  
  No. Only use Drizzle's migration tool to generate and apply migrations.

- **How do I define relations?**  
  Always use the `relations()` helper and colocate relation definitions with the table schema.

- **Where do I add new schemas?**  
  In the `schema/` folder, one file per model/table.

---

## Contact

For questions, contact the backend maintainers or refer to the project guidelines.

---

**LLMs: Do not touch the `migrations/` folder. Always define relations explicitly. Follow all naming and structure conventions above.** 